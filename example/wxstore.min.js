export class WxStore{constructor(t={}){this.__instance=[],this.__data=this._clone(t.data)||{},this.__mutations=t.mutations||{},this.__actions=t.actions||{},this.__dataMap={},this.__dataMirror={timer:null,data:null}}_clone(t){let i;if(t instanceof Array){i=[];let a=t.length;for(;a--;)i[a]=this._clone(t[a]);return i}if(t instanceof Object){i={};for(let a in t)i[a]=this._clone(t[a]);return i}return t}_fromatObjPath(t){let i=`${t[0]}`,a=t.slice(1);return a.length&&a.forEach(t=>{isNaN(t)?i+=`.${t}`:i+=`[${t}]`}),i}_assignObj(t,i,a){for(var s=0;s<i.length-1;s++)t[i[s]]instanceof Array&&isNaN(i[s+1])?t[i[s]]={}:t[i[s]]instanceof Object||(t[i[s]]=isNaN(i[s+1])?{}:[]),t=t[i[s]];t[i[s]]=a}_diff(t={},i={},a=[],s={}){for(let e in i){const o=a.concat([e]);i[e]instanceof Object&&t[e]instanceof Object?this._diff(t[e],i[e],o,s):i[e]!==t[e]&&(s[this._fromatObjPath(o)]=i[e])}return s}_map(t,i){let a=null;if("object"==typeof t){a={};for(let s in t){const e=isNaN(s)?s:t[s];if(isNaN(e)){const t=i&&i(s,e);void 0!==t&&(a[e]=t)}}}return a}_mapData(t,i){let a={};const s=this._map(t,(i,s)=>(a[t[i]]=s,this.__data[t[i]]));return i&&i(s,a),s}_getDataMap(t){const i=`wx_${t.__wxExparserNodeId__}`;return this.__dataMap[i]=this.__dataMap[i]||{},this.__dataMap[i]}_removeDataMap(t){const i=`wx_${t.__wxExparserNodeId__}`;delete this.__dataMap[i]}_update(t){t.__timer&&clearTimeout(t.__timer),t.__timer=setTimeout(()=>{t.setData(t.__diffData),t.__diffData={},t.__timer=null})}_init(t,i){i.__diffData=i.__diffData||{};let a=this._getDataMap(i);"object"==typeof t.bindData?this._mapData(t.bindData,(t,s)=>{Object.assign(a,s),!this.__instance.includes(i)&&this.__instance.push(i),t&&(Object.assign(i.__diffData,t),this._update(i))}):"function"==typeof t.bindData?(t.bindData=t.bindData(),this._init(t,i)):console.error(new Error("bindData is not object"))}_detach(t){let i=this.__instance.indexOf(t);i>-1&&this.__instance.splice(i,1),this._removeDataMap(t)}_dataMirror(){return this.__dataMirror.timer&&clearTimeout(this.__dataMirror.timer),this.__dataMirror.timer=setTimeout(()=>{this.__dataMirror.data=this.__dataMirror.timer=null}),this.__dataMirror.data||this._clone(this.__data)}bindStores(t,i){if(t instanceof Array){if(t[0]){const a=t.shift();a&&a[0]&&a[0]._init&&a[0]._init({bindData:a[1]},i),this.bindStores(t,i)}}else console.error(new Error("bindStores is not Array"))}setData(t){t instanceof Object?this.__instance.forEach((i,a)=>{let s=!1,e={},o=this._getDataMap(i);for(let n in t)if(void 0!==this.__data[n])void 0!==o[n]&&(s=!0,e[o[n]]=t[n]),!a&&(this.__data[n]=t[n]);else{let e=n.match(/[^\[|\]|\.]+/g);void 0!==this.__data[e[0]]&&e.length>1&&(void 0!==o[e[0]]&&(s=!0,i.__diffData[this._fromatObjPath([...e])]=t[n]),!a&&this._assignObj(this.__data,e,t[n]))}Object.assign(i.__diffData,this._diff(i.data,e)),s&&this._update(i)}):console.error(new Error("setData params should object"))}commit(t,i){"string"==typeof t&&"function"==typeof this.__mutations[t]?this.__mutations[t]({data:this._dataMirror(),payload:i,setData:this.setData.bind(this)}):console.error(new Error(`mutations["${t}"] is undefined`))}dispatch(t,i){"string"==typeof t&&"function"==typeof this.__actions[t]?this.__actions[t]({data:this._dataMirror(),payload:i,commit:this.commit.bind(this)}):console.error(new Error(`actions["${t}"] is undefined`))}mapMutations(t){return this._map(t,i=>a=>{this.commit(t[i],a)})}mapActions(t){return this._map(t,i=>a=>{this.dispatch(t[i],a)})}}export function getCurrentPage(t){const i=t.getPageId(),a=getCurrentPages();for(let t=0;t<a.length;t++)if(i===a[t].getPageId())return a[t]}export function StorePage(t){const i=t.onLoad,a=t.onUnload;t.onLoad=function(){this._store=new WxStore(t.store),this._store.bindStores([...t.bindStores],this),this._store._init(t,this),Object.assign(this,this._store.mapActions(t.mapActions),this._store.mapMutations(t.mapMutations)),i&&i.apply(this,arguments)},t.onUnload=function(){this._store&&this._store._detach(this),a&&a.apply(this,arguments)},Page(t)}export function StoreComponent(t){const i=t.ready,a=t.detached;t.ready=function(){const a=getCurrentPage(this);a._store?(this._store=a._store,this._store.bindStores([...t.bindStores],this),this._store._init(t,this),Object.assign(this,this._store.mapActions(t.mapActions),this._store.mapMutations(t.mapMutations)),i&&i.apply(this,arguments)):i&&i.apply(this,arguments)},t.detached=function(){this._store&&this._store._detach(this),a&&a.apply(this,arguments)},Component(t)}